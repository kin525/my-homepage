<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="ROBOTS" content="NOARCHIVE">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Luen Hing Survey Program - Horizontal Alignment</title>
    <style>
        /* Styles unchanged (omitted here for brevity in explanation) */
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:#f5f5f5; padding:15px; color:#333; }
        .container { max-width:600px; margin:0 auto; background:white; border-radius:12px; padding:20px; box-shadow:0 2px 10px rgba(0,0,0,.1);}
        h3 {text-align:center; color:#2c3e50; margin-bottom:10px;}
        /* rest of CSS kept the same as your version */
        input[type="text"]{ width:100%; padding:12px; border:2px solid #ddd; border-radius:8px; font-size:16px; margin-bottom:10px; background:white; }
        fieldset{ border:2px solid #e0e0e0; border-radius:8px; padding:15px; margin-bottom:20px; background:#fafafa; }
        legend{ font-weight:bold; padding:0 10px; color:#555; }
        .button-group{ display:flex; gap:10px; }
        .number-input-container{ position:relative; }
        .clear-btn{ position:absolute; right:10px; top:50%; transform:translateY(-50%); background:none; border:none; font-size:18px; color:#999; cursor:pointer; display:none; padding:5px; z-index:10; }
        input:not(:placeholder-shown) + .clear-btn { display:block; }
    </style>
</head>
<body>
  <div class="container">
    <h3>Kin Write Horizontal Alignment</h3>
    <p style="text-align:center; color:#666;">Email: kin525@yahoo.com.hk</p>

    <form name="STN" id="alignmentForm">
      <fieldset>
        <legend>Alignment Data</legend>
        <div class="input-group">
          <label for="startChInput">Start CH:</label>
          <div class="number-input-container">
            <input id="startChInput" name="text1" type="text" inputmode="decimal" placeholder="Enter start chainage" size="12">
            <button type="button" class="clear-btn" onclick="clearInput('startChInput')">×</button>
          </div>
        </div>

        <div class="input-row">
          <div class="input-group">
            <label for="startNInput">Start N:</label>
            <div class="number-input-container">
              <input id="startNInput" name="text2" type="text" inputmode="decimal" placeholder="Enter N coordinate" size="12">
              <button type="button" class="clear-btn" onclick="clearInput('startNInput')">×</button>
            </div>
          </div>

          <div class="input-group">
            <label for="startEInput">Start E:</label>
            <div class="number-input-container">
              <input id="startEInput" name="text3" type="text" inputmode="decimal" placeholder="Enter E coordinate" size="12">
              <button type="button" class="clear-btn" onclick="clearInput('startEInput')">×</button>
            </div>
          </div>
        </div>

        <div class="input-row">
          <div class="input-group">
            <label for="tBrgInput">T.Brg (deg):</label>
            <div class="number-input-container">
              <input id="tBrgInput" name="text4" type="text" inputmode="decimal" placeholder="Enter tangent bearing (decimal degrees)" size="9">
              <button type="button" class="clear-btn" onclick="clearInput('tBrgInput')">×</button>
            </div>
          </div>

          <div class="input-group">
            <label for="radiusInput">R(+/-):</label>
            <div class="number-input-container">
              <input id="radiusInput" name="text5" type="text" inputmode="decimal" placeholder="Enter radius (leave empty for straight line)" size="10">
              <button type="button" class="clear-btn" onclick="clearInput('radiusInput')">×</button>
            </div>
          </div>
        </div>

        <div class="input-group">
          <label for="spiralInput">SPL(+/-):</label>
          <div class="number-input-container">
            <input id="spiralInput" name="text6" type="text" inputmode="decimal" placeholder="Enter spiral length (optional)" size="10">
            <button type="button" class="clear-btn" onclick="clearInput('spiralInput')">×</button>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>NEL Input Data</legend>
        <div class="input-row">
          <div class="input-group">
            <label for="nxInput">Nx:</label>
            <div class="number-input-container">
              <input id="nxInput" name="text7" type="text" inputmode="decimal" placeholder="Enter Nx" size="10">
              <button type="button" class="clear-btn" onclick="clearInput('nxInput')">×</button>
            </div>
          </div>

          <div class="input-group">
            <label for="exInput">Ex:</label>
            <div class="number-input-container">
              <input id="exInput" name="text8" type="text" inputmode="decimal" placeholder="Enter Ex" size="10">
              <button type="button" class="clear-btn" onclick="clearInput('exInput')">×</button>
            </div>
          </div>
        </div>

        <div class="input-group">
          <label for="tBrgResultInput">T.Brg:</label>
          <input id="tBrgResultInput" name="text9" type="text" readonly style="background:#f0f0f0;">
        </div>

        <input type="button" value="CALL ANSWER" onclick="CALL_ANSWER()">
        <input type="button" value="CALCULATE FROM COORDINATES" onclick="RUNIt1()">
      </fieldset>

      <fieldset>
        <legend>CH/OS Input Data</legend>
        <div class="input-row">
          <div class="input-group">
            <label for="chInput">CH:</label>
            <div class="number-input-container">
              <input id="chInput" name="text10" type="text" inputmode="decimal" placeholder="Enter chainage" size="12">
              <button type="button" class="clear-btn" onclick="clearInput('chInput')">×</button>
            </div>
          </div>

          <div class="input-group">
            <label for="osInput">OS:</label>
            <div class="number-input-container">
              <input id="osInput" name="text11" type="text" inputmode="decimal" placeholder="Enter offset" size="12">
              <button type="button" class="clear-btn" onclick="clearInput('osInput')">×</button>
            </div>
          </div>
        </div>

        <div class="input-group">
          <label for="finalTBrgInput">T.Brg:</label>
          <input id="finalTBrgInput" name="text12" type="text" readonly style="background:#f0f0f0;">
        </div>

        <div class="button-group">
          <input type="button" value="CALCULATE FROM CH/OS" onclick="RUNIt2()">
          <input type="button" value="CLEAR DATA" onclick="CLSIt2()">
        </div>
      </fieldset>
    </form>
  </div>

  <!-- ======== Begin inlined function.js contents ======== -->
  <script>
  "use strict";
  const PI = Math.PI;
  const EPS = 1e-12;
  function toRad(deg) { return deg * PI / 180; }
  function toDeg(rad) { return rad * 180 / PI; }
  function dms(z) {
    let d = Math.floor(z);
    let m = Math.floor((z - d) * 60);
    let s = Math.floor(((((z - d) * 60) - m) * 60) * 10 + 0.5) / 10;
    if (s >= 60) { s -= 60; m += 1; }
    if (m >= 60) { m -= 60; d += 1; }
    return d + (m / 100) + (s / 10000);
  }
  function dmscode(z) {
    let d = Math.floor(z);
    let m = Math.floor((z - d) * 60);
    let s = Math.floor(((((z - d) * 60) - m) * 60) * 10 + 0.5) / 10;
    if (s >= 60) { s -= 60; m += 1; }
    if (m >= 60) { m -= 60; d += 1; }
    return d + "^" + m + "'" + s + "\"";
  }
  function fix3(z) { return Math.floor(z * 1000 + 0.5) / 1000; }
  function fix4(z) { return Math.floor(z * 10000 + 0.5) / 10000; }
  function fix5(z) { return Math.floor(z * 100000 + 0.5) / 100000; }
  function deg(z) {
    const d = Math.floor(z);
    const m = Math.floor((z - d) * 100);
    const part1 = d;
    const part2 = m / 60;
    const part3 = ((100 * z - Math.floor(100 * z)) * 100) / 3600;
    return part1 + part2 + part3;
  }
  function fsin(z) { return Math.sin(toRad(z)); }
  function fcos(z) { return Math.cos(toRad(z)); }
  function ftan(z) { return Math.tan(toRad(z)); }
  function jointdist(n, e, n2, e2) {
    const x = n2 - n; const y = e2 - e;
    return Math.sqrt(x * x + y * y);
  }
  function joint(n, e, n2, e2) {
    const x = n2 - n; const y = e2 - e;
    let brg = Math.atan2(y, x) * 180 / PI;
    if (brg < 0) brg += 360;
    return brg;
  }
  function atan2deg(x, y) {
    let a = Math.atan2(y, x) * 180 / PI;
    if (a < 0) a += 360;
    return a;
  }

  // linech / lineos / linenx / lineex (same logic as before)
  function linech(bn, be, bh, tb, nx, ex) {
    const tb1 = deg(tb);
    const z = jointdist(bn, be, nx, ex);
    const brg = joint(bn, be, nx, ex);
    const aa = brg - tb1;
    const ch = fcos(aa) * z + fix3(bh);
    return ch;
  }
  function lineos(bn, be, bh, tb, nx, ex) {
    const tb1 = deg(tb);
    const z = jointdist(bn, be, nx, ex);
    const brg = joint(bn, be, nx, ex);
    const aa = brg - tb1;
    const os = fsin(aa) * z;
    return os;
  }
  function linenx(bn, be, bh, tb, rh, ro) {
    const tb1 = deg(tb);
    rh = rh - fix3(bh);
    const d = Math.sqrt(rh * rh + ro * ro);
    let c = Math.atan(ro / (rh + EPS)) * 180 / PI;
    if (rh < 0) c = c + 180;
    if (c < 0) c = c + 360;
    const bb = c + tb1;
    const nx = fcos(bb) * d + fix3(bn);
    return nx;
  }
  function lineex(bn, be, bh, tb, rh, ro) {
    const tb1 = deg(tb);
    rh = fix3(rh) - fix3(bh);
    const d = Math.sqrt(rh * rh + ro * ro);
    let c = Math.atan(ro / (rh + EPS)) * 180 / PI;
    if (rh < 0) c = c + 180;
    if (c < 0) c = c + 360;
    const bb = c + tb1;
    const ex = fsin(bb) * d + fix3(be);
    return ex;
  }

  // curve/spiral functions (kept from function.js)
  function curvetb(bn, be, tb, r, bh, rh, ro) {
    const tb1 = deg(tb); let bb = tb1 + 90;
    const cn = fcos(bb) * r + fix3(bn); const ce = fsin(bb) * r + fix3(be);
    if (r > 0) bb = bb + 180; if (bb > 360) bb = bb - 360;
    rh = rh - fix3(bh);
    const aa = rh * 180 / PI / r; bb = bb + aa;
    let tb2 = tb1 + aa;
    if (tb2 < 0) tb2 = tb2 + 360; if (tb2 > 360) tb2 = tb2 - 360;
    return tb2;
  }
  function curvenx(bn, be, tb, r, bh, rh, ro) {
    const tb1 = deg(tb); let bb = tb1 + 90;
    const cn = fcos(bb) * r + fix3(bn); const ce = fsin(bb) * r + fix3(be);
    if (r > 0) bb = bb + 180; if (bb > 360) bb = bb - 360;
    rh = rh - fix3(bh);
    const aa = rh * 180 / PI / r; bb = bb + aa;
    const nx = fcos(bb) * Math.abs(r) + cn;
    const aa2 = (tb1 + aa) + 90;
    const n = fcos(aa2) * ro + nx;
    return n;
  }
  function curveex(bn, be, tb, r, bh, rh, ro) {
    const tb1 = deg(tb); let bb = tb1 + 90;
    const cn = fcos(bb) * r + fix3(bn); const ce = fsin(bb) * r + fix3(be);
    if (r > 0) bb = bb + 180; if (bb > 360) bb = bb - 360;
    rh = rh - fix3(bh);
    const aa = rh * 180 / PI / r; bb = bb + aa;
    const ex = fsin((tb1 + aa) + 90) * ro + (fsin(bb) * Math.abs(r) + ce);
    return ex;
  }
  function curvech(bn, be, tb, r, bh, nx, ex) {
    const tb1 = deg(tb); let bb = tb1 + 90;
    const cn = fcos(bb) * r + fix3(bn); const ce = fsin(bb) * r + fix3(be);
    if (r > 0) bb = bb + 180; if (bb > 360) bb = bb - 360;
    const z = jointdist(cn, ce, nx, ex); const c = joint(cn, ce, nx, ex);
    let a1; if (r > 0) a1 = c - bb; else a1 = bb - c;
    if (a1 < 0) a1 = a1 + 360;
    const l = a1 * PI * Math.abs(r) / 180;
    const ch = l + fix3(bh);
    return ch;
  }
  function curveos(bn, be, tb, r, bh, nx, ex) {
    const tb1 = deg(tb); let bb = tb1 + 90;
    const cn = fcos(bb) * r + fix3(bn); const ce = fsin(bb) * r + fix3(be);
    if (r > 0) bb = bb + 180; if (bb > 360) bb = bb - 360;
    const z = jointdist(cn, ce, nx, ex);
    let os;
    if (r < 0) os = fix3(z) + fix3(r); else os = fix3(r) - fix3(z);
    return os;
  }

  // Spiral functions (kept)
  function spiralnx(bh, bn, be, tb, r, spl, ch, os) {
    bh = fix3(bh); bn = fix5(bn); be = fix5(be); tb = fix5(tb);
    r = fix3(r); spl = fix3(spl); ch = fix3(ch); os = fix3(os);
    const tb1 = deg(tb); const l1_init = fix3(ch) - fix3(bh); const rl = spl * r;
    const l1 = l1_init;
    const x = (Math.pow(l1,3))/(6*rl) - (Math.pow(l1,7))/(336*Math.pow(rl,3)) + (Math.pow(l1,11))/(42240*Math.pow(rl,5)) - (Math.pow(l1,15))/(9676800*Math.pow(rl,7));
    const y = l1 - (Math.pow(l1,5))/(40*Math.pow(rl,2)) + (Math.pow(l1,9))/(3456*Math.pow(rl,4)) - (Math.pow(l1,13))/(599040*Math.pow(rl,6)) + (Math.pow(l1,17))/(175472640*Math.pow(rl,8));
    const nx = fix5(bn) + (y * fcos(tb1)) - (x * fsin(tb1));
    const tb2 = (Math.pow(l1,2)) / (2 * r * spl) * 180 / PI + tb1;
    const n = fix4(fcos(tb2 + 90) * os + fix5(nx));
    return n;
  }
  function spiralex(bh, bn, be, tb, r, spl, ch, os) {
    bh = fix3(bh); bn = fix5(bn); be = fix5(be); tb = fix5(tb);
    r = fix3(r); spl = fix3(spl); ch = fix3(ch); os = fix3(os);
    const tb1 = deg(tb); const l1_init = fix3(ch) - fix3(bh); const rl = spl * r;
    const l1 = l1_init;
    const x = (Math.pow(l1,3))/(6*rl) - (Math.pow(l1,7))/(336*Math.pow(rl,3)) + (Math.pow(l1,11))/(42240*Math.pow(rl,5)) - (Math.pow(l1,15))/(9676800*Math.pow(rl,7));
    const y = l1 - (Math.pow(l1,5))/(40*Math.pow(rl,2)) + (Math.pow(l1,9))/(3456*Math.pow(rl,4)) - (Math.pow(l1,13))/(599040*Math.pow(rl,6)) + (Math.pow(l1,17))/(175472640*Math.pow(rl,8));
    const nx = fix5(bn) + (y * fcos(tb1)) - (x * fsin(tb1));
    const tb2 = (Math.pow(l1,2)) / (2 * r * spl) * 180 / PI + tb1;
    const e = fix4(fsin(tb2 + 90) * os + fix5(nx));
    return e;
  }
  function spiralbrg(bh, bn, be, tb, r, spl, ch, os) {
    bh = fix3(bh); bn = fix5(bn); be = fix5(be); tb = fix5(tb);
    r = fix3(r); spl = fix3(spl); ch = fix3(ch); os = fix3(os);
    const tb1 = deg(tb); const l1 = fix3(ch) - fix3(bh);
    const tb2 = (Math.pow(l1,2)) / (2 * r * spl) * 180 / PI + tb1;
    return tb2;
  }
  function spiralch(bh, bn, be, tb, r, spl, n, e) {
    bh = fix3(bh); bn = fix5(bn); be = fix5(be); tb = fix5(tb);
    r = fix3(r); spl = fix3(spl); n = fix4(n); e = fix4(e);
    const tb1 = deg(tb);
    let l1 = 0.0001; let i = 1; let c = 0; let a3 = 1;
    while (i <= 100) {
      const rl = spl * r;
      const x = (Math.pow(l1,3))/(6*rl) - (Math.pow(l1,7))/(336*Math.pow(rl,3)) + (Math.pow(l1,11))/(42240*Math.pow(rl,5)) - (Math.pow(l1,15))/(9676800*Math.pow(rl,7));
      const y = l1 - (Math.pow(l1,5))/(40*Math.pow(rl,2)) + (Math.pow(l1,9))/(3456*Math.pow(rl,4)) - (Math.pow(l1,13))/(599040*Math.pow(rl,6)) + (Math.pow(l1,17))/(175472640*Math.pow(rl,8));
      const nx = bn + (y * fcos(tb1)) - (x * fsin(tb1));
      const ex = be + (y * fsin(tb1)) + (x * fcos(tb1));
      const tb2 = (Math.pow(l1,2)) / (2 * r * spl) * 180 / PI + tb1;
      i += 1;
      const dx = fix5(n - nx);
      const dy = fix5(e - ex);
      if (dx === 0 && dy === 0) { break; } else {
        const z = Math.sqrt((dx * dx) + (dy * dy));
        c = atan2deg(dx, dy);
        l1 = fcos(c - tb2) * z + l1;
        a3 = Math.abs(fcos(c - tb2));
      }
      if (a3 < 0.0005) break;
    }
    const ch = fix3(bh + (spl / Math.abs(spl)) * Math.abs(l1));
    return ch;
  }
  function spiralos(bh, bn, be, tb, r, spl, n, e) {
    bh = fix3(bh); bn = fix5(bn); be = fix5(be); tb = fix5(tb);
    r = fix3(r); spl = fix3(spl); n = fix4(n); e = fix4(e);
    const tb1 = deg(tb);
    let l1 = 0.0001; let i = 1; let c = 0; let a3 = 1; let dx=0, dy=0, z=0;
    while (i <= 100) {
      const rl = spl * r;
      const x = (Math.pow(l1,3))/(6*rl) - (Math.pow(l1,7))/(336*Math.pow(rl,3)) + (Math.pow(l1,11))/(42240*Math.pow(rl,5)) - (Math.pow(l1,15))/(9676800*Math.pow(rl,7));
      const y = l1 - (Math.pow(l1,5))/(40*Math.pow(rl,2)) + (Math.pow(l1,9))/(3456*Math.pow(rl,4)) - (Math.pow(l1,13))/(599040*Math.pow(rl,6)) + (Math.pow(l1,17))/(175472640*Math.pow(rl,8));
      const nx = bn + (y * fcos(tb1)) - (x * fsin(tb1));
      const ex = be + (y * fsin(tb1)) + (x * fcos(tb1));
      const tb2 = (Math.pow(l1,2)) / (2 * r * spl) * 180 / PI + tb1;
      i += 1;
      dx = fix5(n - nx);
      dy = fix5(e - ex);
      if (dx === 0 && dy === 0) { z = 0; break; } else {
        z = Math.sqrt((dx * dx) + (dy * dy));
        c = atan2deg(dx, dy);
        l1 = fcos(c - tb2) * z + l1;
        a3 = Math.abs(fcos(c - tb2));
      }
      if (a3 < 0.0005) break;
    }
    const a4 = fsin(c - ((Math.pow(l1,2))/(2*r*spl) * 180/PI + tb1));
    let os = fix3(a4 / Math.abs(a4) * z || 0);
    if (spl < 0) os = -Math.abs(os);
    if (dx === 0 && dy === 0) os = 0;
    return os;
  }
  function spiralcheckbrg(bh, bn, be, tb, r, spl, n, e) {
    bh = fix3(bh); bn = fix5(bn); be = fix5(be); tb = fix5(tb);
    r = fix3(r); spl = fix3(spl); n = fix4(n); e = fix4(e);
    const tb1 = deg(tb);
    let l1 = 0.0001; let i = 1; let c = 0; let a3 = 1;
    while (i <= 100) {
      const rl = spl * r;
      const x = (Math.pow(l1,3))/(6*rl) - (Math.pow(l1,7))/(336*Math.pow(rl,3)) + (Math.pow(l1,11))/(42240*Math.pow(rl,5)) - (Math.pow(l1,15))/(9676800*Math.pow(rl,7));
      const y = l1 - (Math.pow(l1,5))/(40*Math.pow(rl,2)) + (Math.pow(l1,9))/(3456*Math.pow(rl,4)) - (Math.pow(l1,13))/(599040*Math.pow(rl,6)) + (Math.pow(l1,17))/(175472640*Math.pow(rl,8));
      const nx = bn + (y * fcos(tb1)) - (x * fsin(tb1));
      const ex = be + (y * fsin(tb1)) + (x * fcos(tb1));
      const tb2 = (Math.pow(l1,2)) / (2 * r * spl) * 180 / PI + tb1;
      i += 1;
      const dx = fix5(n - nx);
      const dy = fix5(e - ex);
      if (dx === 0 && dy === 0) { break; } else {
        const z = Math.sqrt((dx * dx) + (dy * dy));
        c = atan2deg(dx, dy);
        l1 = fcos(c - tb2) * z + l1;
        a3 = Math.abs(fcos(c - tb2));
      }
      if (a3 < 0.0005) break;
    }
    const tb2 = (Math.pow(l1,2)) / (2 * r * spl) * 180 / PI + tb1;
    return tb2;
  }
  </script>
  <!-- ======== End inlined function.js contents ======== -->

  <script>
  // Page script (merged). Set debug true to see log details in Console.
  const debug = false;

  function clearInput(inputId) {
    const input = document.getElementById(inputId);
    input.value = '';
    input.dispatchEvent(new Event('input'));
  }

  function initClearButtons() {
    const inputs = document.querySelectorAll('input[inputmode="decimal"], input[type="text"]');
    inputs.forEach(input => {
      const clearBtn = input.nextElementSibling;
      if (clearBtn && clearBtn.classList && clearBtn.classList.contains('clear-btn')) {
        clearBtn.style.display = input.value ? 'block' : 'none';
      }
      input.addEventListener('input', function() {
        const btn = this.nextElementSibling;
        if (btn && btn.classList && btn.classList.contains('clear-btn')) {
          btn.style.display = this.value ? 'block' : 'none';
        }
      });
    });
  }

  function parseNum(v) {
    if (v === null || v === undefined) return NaN;
    const s = String(v).trim();
    if (s === "") return NaN;
    const s2 = s.replace(',', '.');
    const n = parseFloat(s2);
    return isNaN(n) ? NaN : n;
  }

  function parseBearing(v) {
    if (v === null || v === undefined) return NaN;
    const s = String(v).trim();
    if (s === "") return NaN;
    if (s.indexOf('^') >= 0 || s.indexOf("'") >= 0 || s.indexOf('"') >= 0) {
      const re = /(\d+)[\^\s°]?(\d+)?['\s]?([\d.]+)?["]?/;
      const m = s.match(re);
      if (!m) return NaN;
      const d = parseInt(m[1] || 0, 10);
      const mm = parseInt(m[2] || 0, 10);
      const ss = parseFloat(m[3] || 0);
      return d + mm / 60 + ss / 3600;
    }
    return parseNum(s);
  }

  function dmscode_safe(z) {
    if (isNaN(z)) return "";
    return dmscode(z);
  }

  // Local straight-line helpers (these duplicate earlier but ok here for clarity)
  function linech_local(bn, be, bh, tb, nx, ex) {
    const TN = parseNum(bn), TE = parseNum(be);
    const STCH = parseNum(bh);
    const NX = parseNum(nx), EX = parseNum(ex);
    if (isNaN(TN) || isNaN(TE) || isNaN(STCH) || isNaN(NX) || isNaN(EX)) return NaN;
    const tbDeg = parseBearing(tb);
    if (isNaN(tbDeg)) return NaN;
    const rad = toRad(tbDeg);
    const dn_dir = Math.cos(rad);
    const de_dir = Math.sin(rad);
    const dN = NX - TN;
    const dE = EX - TE;
    const proj = dN * dn_dir + dE * de_dir;
    const CH = STCH + proj;
    return CH;
  }

  // Helper to decide if Nx/Ex look like offsets (small numbers) vs full coordinates
  function convertIfOffsets(nxRaw, exRaw, startNRaw, startERaw) {
    const NX = parseNum(nxRaw);
    const EX = parseNum(exRaw);
    const startN = parseNum(startNRaw);
    const startE = parseNum(startERaw);
    // If both Nx and Ex are numerically small (e.g. <100), treat as offsets and add to start coords.
    // Adjust threshold if your data uses different units.
    const threshold = 100; // meters
    if (!isNaN(NX) && !isNaN(EX) && Math.abs(NX) < threshold && Math.abs(EX) < threshold && !isNaN(startN) && !isNaN(startE)) {
      return { NX_abs: startN + NX, EX_abs: startE + EX, treatedAsOffset: true };
    }
    return { NX_abs: NX, EX_abs: EX, treatedAsOffset: false };
  }

  function RUNIt1() {
    if (debug) console.clear();
    const STCH = document.STN.text1.value;
    const TN = document.STN.text2.value;
    const TE = document.STN.text3.value;
    const TB = document.STN.text4.value;
    const R = document.STN.text5.value;
    const SPL = document.STN.text6.value;
    const NX_raw = document.STN.text7.value;
    const EX_raw = document.STN.text8.value;

    document.STN.text9.value = "";

    // Detect offsets — if user entered small Nx/Ex treat them as offsets
    const conv = convertIfOffsets(NX_raw, EX_raw, TN, TE);
    let NX = conv.NX_abs;
    let EX = conv.EX_abs;
    if (debug) console.log("Converted NX/EX:", NX, EX, "treatedAsOffset:", conv.treatedAsOffset);

    // If no Nx/Ex provided, abort with message
    if (isNaN(NX) || isNaN(EX)) {
      alert("Please enter Nx and Ex (absolute coordinates or small offsets).");
      return;
    }

    // Choose mode: curve (R provided), spiral (SPL provided), or line
    if ((SPL === "" || SPL === null || SPL === undefined) && R !== "") {
      // Curve calculation
      if (typeof curvech === 'function') {
        const rNum = parseNum(R);
        const CH = curvech(TN, TE, TB, rNum, STCH, NX, EX);
        const OS = curveos(TN, TE, TB, rNum, STCH, NX, EX);
        const tb = curvetb(TN, TE, TB, rNum, STCH, CH, OS);
        document.STN.text10.value = (isNaN(CH) ? "" : fix3(CH));
        document.STN.text11.value = (isNaN(OS) ? "" : fix3(OS));
        document.STN.text12.value = dmscode_safe(tb);
        if (debug) console.log("curve result CH,OS,tb:", CH, OS, tb);
      } else {
        alert("Curve functions not available. Check function definitions.");
      }
    } else if (SPL !== "") {
      // Spiral calculation
      if (typeof spiralch === 'function') {
        const rNum = parseNum(R);
        const splNum = parseNum(SPL);
        const CH = spiralch(STCH, TN, TE, TB, rNum, splNum, NX, EX);
        const OS = spiralos(STCH, TN, TE, TB, rNum, splNum, NX, EX);
        const tb = spiralcheckbrg(STCH, TN, TE, TB, rNum, splNum, NX, EX);
        document.STN.text10.value = (isNaN(CH) ? "" : fix3(CH));
        document.STN.text11.value = (isNaN(OS) ? "" : fix3(OS));
        document.STN.text12.value = dmscode_safe(tb);
        if (debug) console.log("spiral result CH,OS,tb:", CH, OS, tb);
      } else {
        alert("Spiral functions not available. Check function definitions.");
      }
    } else {
      // Line calculation
      const CH = linech(TN, TE, STCH, TB, NX, EX);
      const OS = lineos(TN, TE, STCH, TB, NX, EX);
      const tb = parseBearing(TB) || 0;
      document.STN.text10.value = (isNaN(CH) ? "" : fix3(CH));
      document.STN.text11.value = (isNaN(OS) ? "" : fix3(OS));
      document.STN.text12.value = dmscode_safe(tb);
      if (debug) console.log("line result CH,OS,tb:", CH, OS, tb);
    }
  }

  function CLSIt2() {
    document.STN.text7.value = "";
    document.STN.text8.value = "";
    document.STN.text9.value = "";
    document.STN.text10.value = "";
    document.STN.text11.value = "";
    document.STN.text12.value = "";
  }

  function RUNIt2() {
    const STCH = fix3(document.STN.text1.value);
    const TN = document.STN.text2.value;
    const TE = document.STN.text3.value;
    const TB = document.STN.text4.value;
    const R = document.STN.text5.value;
    const SPL = document.STN.text6.value;
    const CH = document.STN.text10.value;
    const OS = document.STN.text11.value;

    document.STN.text12.value = "";

    if ((SPL === "" || SPL === null || SPL === undefined) && R !== "") {
      if (typeof curvenx === 'function') {
        const rNum = parseNum(R);
        const nx = curvenx(TN, TE, TB, rNum, STCH, CH, OS);
        const ex = curveex(TN, TE, TB, rNum, STCH, CH, OS);
        const tb = curvetb(TN, TE, TB, rNum, STCH, CH, OS);
        document.STN.text7.value = (isNaN(nx) ? "" : fix4(nx));
        document.STN.text8.value = (isNaN(ex) ? "" : fix4(ex));
        document.STN.text9.value = dmscode_safe(tb);
      } else {
        alert("Curve functions not available. Check function definitions.");
      }
    } else if (SPL !== "") {
      if (typeof spiralnx === 'function') {
        const rNum = parseNum(R);
        const splNum = parseNum(SPL);
        const nx = spiralnx(STCH, TN, TE, TB, rNum, splNum, CH, OS);
        const ex = spiralex(STCH, TN, TE, TB, rNum, splNum, CH, OS);
        const tb = spiralbrg(STCH, TN, TE, TB, rNum, splNum, CH, OS);
        document.STN.text7.value = (isNaN(nx) ? "" : fix4(nx));
        document.STN.text8.value = (isNaN(ex) ? "" : fix4(ex));
        document.STN.text9.value = dmscode_safe(tb);
      } else {
        alert("Spiral functions not available. Check function definitions.");
      }
    } else {
      const nx = linenx(TN, TE, STCH, TB, CH, OS);
      const ex = lineex(TN, TE, STCH, TB, CH, OS);
      const tb = parseBearing(TB) || 0;
      document.STN.text7.value = (isNaN(nx) ? "" : fix4(nx));
      document.STN.text8.value = (isNaN(ex) ? "" : fix4(ex));
      document.STN.text9.value = dmscode_safe(tb);
    }

    try {
      localStorage.JOINT_N = fix4(document.STN.text7.value);
      localStorage.JOINT_E = fix4(document.STN.text8.value);
    } catch (e) {}
  }

  function CALL_ANSWER() {
    document.STN.text7.value = localStorage.ANSWER_N || '';
    document.STN.text8.value = localStorage.ANSWER_E || '';
    document.STN.text9.value = "";
  }

  document.addEventListener('DOMContentLoaded', function() {
    initClearButtons();
  });

  </script>
</body>
</html>