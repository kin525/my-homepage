<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="ROBOTS" content="NOARCHIVE">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Luen Hing Survey Program - Horizontal Alignment</title>
    <style>
        /* Base reset and responsive design */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 15px;
            line-height: 1.6;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h3 {
            text-align: center;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 24px;
        }

        p {
            margin-bottom: 15px;
        }

        /* Form elements */
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
            -webkit-appearance: none;
            appearance: none;
            background: white;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #007AFF;
        }

        /* Optimize number input for mobile */
        input[type="text"][inputmode="decimal"] {
            -webkit-user-select: text;
            user-select: text;
        }

        /* iOS Safari optimizations */
        @supports (-webkit-touch-callout: none) {
            input[type="text"][inputmode="decimal"] {
                font-size: 16px; /* Prevent zoom on iOS */
            }
        }

        fieldset {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background: #fafafa;
        }

        legend {
            font-weight: bold;
            padding: 0 10px;
            color: #555;
        }

        /* Buttons */
        input[type="button"] {
            width: 100%;
            padding: 12px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 10px;
        }

        input[type="button"]:active {
            background: #0056cc;
            transform: scale(0.98);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .button-group input[type="button"] {
            flex: 1;
        }

        /* Result section */
        .result-section {
            background: #e8f4ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            input[type="text"], input[type="button"] {
                padding: 10px;
                font-size: 14px;
            }
        }

        /* Number input container */
        .number-input-container {
            position: relative;
        }

        .number-input-container input {
            padding-right: 40px;
        }

        .clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 18px;
            color: #999;
            cursor: pointer;
            display: none;
            padding: 5px;
            z-index: 10;
        }

        input:not(:placeholder-shown) + .clear-btn {
            display: block;
        }

        /* Form labels */
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        /* Compact layout for coordinate inputs */
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-group {
            flex: 1;
        }

        .input-group label {
            font-size: 14px;
            margin-bottom: 3px;
        }

        /* Section headers */
        .section-header {
            background: #f0f0f0;
            padding: 8px 15px;
            margin: 20px 0 15px 0;
            border-radius: 6px;
            font-weight: bold;
            color: #555;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <h3>Kin Write Horizontal Alignment</h3>
        <p style="text-align: center; color: #666;">Email: kin525@yahoo.com.hk</p>

        <form name="STN" id="alignmentForm">
            <fieldset>
                <legend>Alignment Data</legend>
                <div class="input-group">
                    <label for="startChInput">Start CH:</label>
                    <div class="number-input-container">
                        <input id="startChInput" name="text1" type="text" 
                               inputmode="decimal" 
                               pattern="[0-9.]*" 
                               placeholder="Enter start chainage"
                               size="12">
                        <button type="button" class="clear-btn" onclick="clearInput('startChInput')">×</button>
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-group">
                        <label for="startNInput">Start N:</label>
                        <div class="number-input-container">
                            <input id="startNInput" name="text2" type="text" 
                                   inputmode="decimal" 
                                   pattern="[0-9.]*" 
                                   placeholder="Enter N coordinate"
                                   size="12">
                            <button type="button" class="clear-btn" onclick="clearInput('startNInput')">×</button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="startEInput">Start E:</label>
                        <div class="number-input-container">
                            <input id="startEInput" name="text3" type="text" 
                                   inputmode="decimal" 
                                   pattern="[0-9.]*" 
                                   placeholder="Enter E coordinate"
                                   size="12">
                            <button type="button" class="clear-btn" onclick="clearInput('startEInput')">×</button>
                        </div>
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-group">
                        <label for="tBrgInput">T.Brg (deg):</label>
                        <div class="number-input-container">
                            <input id="tBrgInput" name="text4" type="text" 
                                   inputmode="decimal" 
                                   pattern="[0-9.]*" 
                                   placeholder="Enter tangent bearing (decimal degrees)"
                                   size="9">
                            <button type="button" class="clear-btn" onclick="clearInput('tBrgInput')">×</button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="radiusInput">R(+/-):</label>
                        <div class="number-input-container">
                            <input id="radiusInput" name="text5" type="text" 
                                   inputmode="decimal" 
                                   pattern="-?[0-9.]*" 
                                   placeholder="Enter radius (leave empty for straight line)"
                                   size="10">
                            <button type="button" class="clear-btn" onclick="clearInput('radiusInput')">×</button>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label for="spiralInput">SPL(+/-):</label>
                    <div class="number-input-container">
                        <input id="spiralInput" name="text6" type="text" 
                               inputmode="decimal" 
                               pattern="-?[0-9.]*" 
                               placeholder="Enter spiral length (optional)"
                               size="10">
                        <button type="button" class="clear-btn" onclick="clearInput('spiralInput')">×</button>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>NEL Input Data</legend>
                <div class="input-row">
                    <div class="input-group">
                        <label for="nxInput">Nx:</label>
                        <div class="number-input-container">
                            <input id="nxInput" name="text7" type="text" 
                                   inputmode="decimal" 
                                   pattern="[0-9.]*" 
                                   placeholder="Enter Nx"
                                   size="10">
                            <button type="button" class="clear-btn" onclick="clearInput('nxInput')">×</button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="exInput">Ex:</label>
                        <div class="number-input-container">
                            <input id="exInput" name="text8" type="text" 
                                   inputmode="decimal" 
                                   pattern="[0-9.]*" 
                                   placeholder="Enter Ex"
                                   size="10">
                            <button type="button" class="clear-btn" onclick="clearInput('exInput')">×</button>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label for="tBrgResultInput">T.Brg:</label>
                    <input id="tBrgResultInput" name="text9" type="text" readonly style="background: #f0f0f0;">
                </div>
                
                <input type="button" value="CALL ANSWER" onclick="CALL_ANSWER()">
                <input type="button" value="CALCULATE FROM COORDINATES" onclick="RUNIt1()">
            </fieldset>

            <fieldset>
                <legend>CH/OS Input Data</legend>
                <div class="input-row">
                    <div class="input-group">
                        <label for="chInput">CH:</label>
                        <div class="number-input-container">
                            <input id="chInput" name="text10" type="text" 
                                   inputmode="decimal" 
                                   pattern="[0-9.]*" 
                                   placeholder="Enter chainage"
                                   size="12">
                            <button type="button" class="clear-btn" onclick="clearInput('chInput')">×</button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="osInput">OS:</label>
                        <div class="number-input-container">
                            <input id="osInput" name="text11" type="text" 
                                   inputmode="decimal" 
                                   pattern="-?[0-9.]*" 
                                   placeholder="Enter offset"
                                   size="12">
                            <button type="button" class="clear-btn" onclick="clearInput('osInput')">×</button>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label for="finalTBrgInput">T.Brg:</label>
                    <input id="finalTBrgInput" name="text12" type="text" readonly style="background: #f0f0f0;">
                </div>
                
                <div class="button-group">
                    <input type="button" value="CALCULATE FROM CH/OS" onclick="RUNIt2()">
                    <input type="button" value="CLEAR DATA" onclick="CLSIt2()">
                </div>
            </fieldset>
        </form>
    </div>

    <script>
        // Input handling functions
        function clearInput(inputId) {
            const input = document.getElementById(inputId);
            input.value = '';
            // trigger input events for clear button visibility
            input.dispatchEvent(new Event('input'));
        }

        // Initialize clear button visibility
        function initClearButtons() {
            const inputs = document.querySelectorAll('input[inputmode="decimal"], input[type="text"]');
            inputs.forEach(input => {
                const clearBtn = input.nextElementSibling;
                if (clearBtn && clearBtn.classList && clearBtn.classList.contains('clear-btn')) {
                    // set initial visibility
                    clearBtn.style.display = input.value ? 'block' : 'none';
                }
                input.addEventListener('input', function() {
                    const btn = this.nextElementSibling;
                    if (btn && btn.classList && btn.classList.contains('clear-btn')) {
                        btn.style.display = this.value ? 'block' : 'none';
                    }
                });
            });
        }

        // --- Helper numeric parsing and angle parsing ---
        function parseNum(v) {
            if (v === null || v === undefined) return NaN;
            const s = String(v).trim();
            if (s === "") return NaN;
            // try to handle comma as decimal
            const s2 = s.replace(',', '.');
            const n = parseFloat(s2);
            return isNaN(n) ? NaN : n;
        }

        // Accept decimal degrees or DMS formatted as 123^45'6.7"
        function parseBearing(v) {
            if (v === null || v === undefined) return NaN;
            const s = String(v).trim();
            if (s === "") return NaN;
            if (s.indexOf('^') >= 0 || s.indexOf("'") >= 0 || s.indexOf('"') >= 0) {
                // parse D^M'S"
                const re = /(\d+)[\^\s°]?(\d+)?['\s]?([\d.]+)?["]?/;
                const m = s.match(re);
                if (!m) return NaN;
                const d = parseInt(m[1] || 0, 10);
                const mm = parseInt(m[2] || 0, 10);
                const ss = parseFloat(m[3] || 0);
                return d + mm / 60 + ss / 3600;
            }
            // fallback to float
            return parseNum(s);
        }

        // Degree to radians
        function toRad(d) { return d * Math.PI / 180; }
        function toDeg(r) { return r * 180 / Math.PI; }

        // formatting helpers used elsewhere
        function dmscode(z) {
            if (isNaN(z)) return "";
            let d = Math.floor(z);
            let m = Math.floor((z - Math.floor(z)) * 60);
            let s = Math.floor(((((z - Math.floor(z)) * 60) - Math.floor((z - Math.floor(z)) * 60)) * 60) * 10 + 0.5) / 10;

            if (s >= 60) {
                s = s - 60;
                m = m + 1;
            }
            
            if (m >= 60) {
                m = m - 60;
                d = d + 1;
            }

            const brg = d + "^" + m + "'" + s + "\"";
            return brg;
        }

        function fix3(z) {
            z = parseNum(z);
            if (isNaN(z)) return "";
            return (Math.floor(z * 1000 + 0.5) / 1000).toFixed(3);
        }

        function fix4(z) {
            z = parseNum(z);
            if (isNaN(z)) return "";
            return (Math.floor(z * 10000 + 0.5) / 10000).toFixed(4);
        }

        function fix5(z) {
            z = parseNum(z);
            if (isNaN(z)) return "";
            return (Math.floor(z * 100000 + 0.5) / 100000).toFixed(5);
        }

        // --- Implemented straight-line geometric functions ---
        // Alignment is a straight line starting at (bn, be) with bearing tb (degrees, azimuth from North).
        // Coordinates: N = northing, E = easting.
        // linech: given an external point (nx,ex), returns chainage along alignment measured from bh (start chainage)
        function linech(bn, be, bh, tb, nx, ex) {
            const TN = parseNum(bn), TE = parseNum(be);
            const STCH = parseNum(bh);
            const NX = parseNum(nx), EX = parseNum(ex);
            if (isNaN(TN) || isNaN(TE) || isNaN(STCH) || isNaN(NX) || isNaN(EX)) return NaN;
            const tbDeg = parseBearing(tb);
            if (isNaN(tbDeg)) return NaN;

            const rad = toRad(tbDeg);
            const dn_dir = Math.cos(rad); // north component
            const de_dir = Math.sin(rad); // east component

            const dN = NX - TN;
            const dE = EX - TE;

            const proj = dN * dn_dir + dE * de_dir; // distance along
            const CH = STCH + proj;
            return CH;
        }

        // lineos: perpendicular offset (signed). Positive offset = to the right of alignment (90° clockwise)
        function lineos(bn, be, bh, tb, nx, ex) {
            const TN = parseNum(bn), TE = parseNum(be);
            const NX = parseNum(nx), EX = parseNum(ex);
            if (isNaN(TN) || isNaN(TE) || isNaN(NX) || isNaN(EX)) return NaN;
            const tbDeg = parseBearing(tb);
            if (isNaN(tbDeg)) return NaN;

            const rad = toRad(tbDeg);
            const dn_dir = Math.cos(rad);
            const de_dir = Math.sin(rad);

            const dN = NX - TN;
            const dE = EX - TE;

            const offset = dN * de_dir - dE * dn_dir; // signed offset
            return offset;
        }

        // linenx: given CH & OS compute NX
        function linenx(bn, be, bh, tb, rh, ro) {
            const TN = parseNum(bn), TE = parseNum(be);
            const STCH = parseNum(bh);
            const CH = parseNum(rh);
            const OS = parseNum(ro);
            if (isNaN(TN) || isNaN(TE) || isNaN(STCH) || isNaN(CH) || isNaN(OS)) return NaN;
            const tbDeg = parseBearing(tb);
            if (isNaN(tbDeg)) return NaN;

            const rad = toRad(tbDeg);
            const dn_dir = Math.cos(rad);
            const de_dir = Math.sin(rad);

            const delta = CH - STCH;
            // right unit vector (north component = de_dir)
            const rn = de_dir;
            const nx = TN + delta * dn_dir + OS * rn;
            return nx;
        }

        // lineex: given CH & OS compute EX
        function lineex(bn, be, bh, tb, rh, ro) {
            const TN = parseNum(bn), TE = parseNum(be);
            const STCH = parseNum(bh);
            const CH = parseNum(rh);
            const OS = parseNum(ro);
            if (isNaN(TN) || isNaN(TE) || isNaN(STCH) || isNaN(CH) || isNaN(OS)) return NaN;
            const tbDeg = parseBearing(tb);
            if (isNaN(tbDeg)) return NaN;

            const rad = toRad(tbDeg);
            const dn_dir = Math.cos(rad);
            const de_dir = Math.sin(rad);

            const delta = CH - STCH;
            // right unit vector (east component = -dn_dir)
            const re = -dn_dir;
            const ex = TE + delta * de_dir + OS * re;
            return ex;
        }

        // For now we do not implement curve/spiral math — show a clear message.
        function unsupportedCurve(mode) {
            alert("Curve/Spiral calculations are not implemented in this build.\nMode: " + mode + "\nPlease use straight-line inputs or request implementation.");
        }

        // Original main functions with modern improvements
        function RUNIt1() {
            let CH = 0;
            let OS = 0;

            const STCH = document.STN.text1.value;
            const TN = document.STN.text2.value;
            const TE = document.STN.text3.value;
            const TB = document.STN.text4.value;
            const R = document.STN.text5.value;
            const SPL = document.STN.text6.value;
            const NX = document.STN.text7.value;
            const EX = document.STN.text8.value;
            
            document.STN.text9.value = "";

            // If radius or spiral provided: not implemented here
            if ((SPL === "" || SPL === null || SPL === undefined) && R !== "") {
                unsupportedCurve("curve");
                return;
            } else if (SPL !== "") {
                unsupportedCurve("spiral");
                return;
            } else {
                // Line calculation
                const ch = linech(TN, TE, STCH, TB, NX, EX);
                const os = lineos(TN, TE, STCH, TB, NX, EX);
                if (isNaN(ch) || isNaN(os)) {
                    alert("Invalid inputs for line calculation. Please check Start N/E, Start CH, T.Brg, and Nx/Ex.");
                    return;
                }
                const tbDeg = parseBearing(TB);
                document.STN.text12.value = dmscode(tbDeg || 0);
                document.STN.text10.value = fix3(ch);
                document.STN.text11.value = fix3(os);
            }
        }

        function CLSIt2() {
            document.STN.text7.value = "";
            document.STN.text8.value = "";
            document.STN.text9.value = "";
            document.STN.text10.value = "";
            document.STN.text11.value = "";
            document.STN.text12.value = "";
        }

        function RUNIt2() {
            const STCH_raw = document.STN.text1.value;
            const TN = document.STN.text2.value;
            const TE = document.STN.text3.value;
            const TB = document.STN.text4.value;
            const R = document.STN.text5.value;
            const SPL = document.STN.text6.value;
            const CH = document.STN.text10.value;
            const OS = document.STN.text11.value;
            
            document.STN.text12.value = "";

            if ((SPL === "" || SPL === null || SPL === undefined) && R !== "") {
                unsupportedCurve("curve");
                return;
            } else if (SPL !== "") {
                unsupportedCurve("spiral");
                return;
            } else {
                // Line calculation
                const nx = linenx(TN, TE, STCH_raw, TB, CH, OS);
                const ex = lineex(TN, TE, STCH_raw, TB, CH, OS);
                if (isNaN(nx) || isNaN(ex)) {
                    alert("Invalid inputs for CH/OS calculation. Please check Start N/E, Start CH, T.Brg, CH and OS.");
                    return;
                }
                const tbDeg = parseBearing(TB);
                document.STN.text7.value = fix4(nx);
                document.STN.text8.value = fix4(ex);
                document.STN.text9.value = dmscode(tbDeg || 0);

                // Save last joint coords (as previously)
                try {
                    localStorage.JOINT_N = fix4(nx);
                    localStorage.JOINT_E = fix4(ex);
                } catch (e) {
                    // ignore localStorage errors in restricted environments
                }
            }
        }

        function CALL_ANSWER() {
            document.STN.text7.value = localStorage.ANSWER_N || '';
            document.STN.text8.value = localStorage.ANSWER_E || '';
            document.STN.text9.value = "";
        }

        // Stubbed complex functions remain but are not used for straight-line mode
        function curvetb(){ return NaN; }
        function curvenx(){ return NaN; }
        function curveex(){ return NaN; }
        function curvech(){ return NaN; }
        function curveos(){ return NaN; }
        function spiralnx(){ return NaN; }
        function spiralex(){ return NaN; }
        function spiralbrg(){ return NaN; }
        function spiralch(){ return NaN; }
        function spiralos(){ return NaN; }
        function spiralcheckbrg(){ return NaN; }

        // Page load initialization
        document.addEventListener('DOMContentLoaded', function() {
            initClearButtons();
        });
    </script>
</body>
</html>