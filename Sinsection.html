<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="ROBOTS" content="NOARCHIVE">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Luen Hing Survey Program - SIN SECTION Calculation</title>
    <style>
        /* Base reset and responsive design */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 15px;
            line-height: 1.6;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h3 {
            text-align: center;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 24px;
        }

        p {
            margin-bottom: 15px;
        }

        /* Form elements */
        select, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
            -webkit-appearance: none;
            appearance: none;
            background: white;
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #007AFF;
        }

        /* Optimize number input for mobile */
        input[type="text"][inputmode="decimal"] {
            -webkit-user-select: text;
            user-select: text;
        }

        /* iOS Safari optimizations */
        @supports (-webkit-touch-callout: none) {
            input[type="text"][inputmode="decimal"] {
                font-size: 16px; /* Prevent zoom on iOS */
            }
        }

        fieldset {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background: #fafafa;
        }

        legend {
            font-weight: bold;
            padding: 0 10px;
            color: #555;
        }

        /* Buttons */
        input[type="button"] {
            width: 100%;
            padding: 12px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 10px;
        }

        input[type="button"]:active {
            background: #0056cc;
            transform: scale(0.98);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .button-group input[type="button"] {
            flex: 1;
        }

        /* Result section */
        .result-section {
            background: #e8f4ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            select, input[type="text"], input[type="button"] {
                padding: 10px;
                font-size: 14px;
            }
        }

        /* Number input container */
        .number-input-container {
            position: relative;
        }

        .number-input-container input {
            padding-right: 40px;
        }

        .clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 18px;
            color: #999;
            cursor: pointer;
            display: none;
            padding: 5px;
            z-index: 10;
        }

        input:not(:placeholder-shown) + .clear-btn {
            display: block;
        }

        /* Form labels */
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        /* Compact layout for coordinate inputs */
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-group {
            flex: 1;
        }

        .input-group label {
            font-size: 14px;
            margin-bottom: 3px;
        }

        /* Section headers */
        .section-header {
            background: #f0f0f0;
            padding: 8px 15px;
            margin: 20px 0 15px 0;
            border-radius: 6px;
            font-weight: bold;
            color: #555;
            text-align: center;
        }

        /* error area */
        .error-box {
            background: #ffecec;
            color: #8a1f11;
            border: 1px solid #f5c6c6;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 12px;
            display: none;
        }
    </style>

    <!-- External logic files -->
    <script src="station.js"></script>
    <script src="sinsection.js"></script>
</head>

<body>
    <div class="container">
        <h3>Kin Write SIN SECTION</h3>
        <p style="text-align: center; color: #666;">Email: kin525@yahoo.com.hk</p>

        <div id="initError" class="error-box" role="alert" aria-live="polite"></div>

        <form name="STN" id="surveyForm" novalidate>
            <div class="form-group">
                <label for="contractSelect">Contract Number:</label>
                <select id="contractSelect" name="contact">
                    <option value="Select Site">Select Site</option>
                </select>
            </div>

            <fieldset>
                <legend>Instrument Station Data</legend>
                <div class="form-group">
                    <label for="fromStationSelect">Station:</label>
                    <select id="fromStationSelect" name="staionselect1">
                        <option value="Station Name">Station Name</option>
                    </select>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label for="stnInput">ST.N:</label>
                        <div class="number-input-container">
                            <input id="stnInput" name="text2" type="text" 
                                   inputmode="decimal" 
                                   pattern="[0-9.]*" 
                                   placeholder="Enter ST.N"
                                   size="12">
                            <button type="button" class="clear-btn" onclick="clearInput('stnInput')">×</button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="steInput">ST.E:</label>
                        <div class="number-input-container">
                            <input id="steInput" name="text3" type="text" 
                                   inputmode="decimal" 
                                   pattern="[0-9.]*" 
                                   placeholder="Enter ST.E"
                                   size="12">
                            <button type="button" class="clear-btn" onclick="clearInput('steInput')">×</button>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label for="rlInput">ST.RL:</label>
                    <div class="number-input-container">
                        <input id="rlInput" name="text4" type="text" 
                               inputmode="decimal" 
                               pattern="[0-9.]*" 
                               placeholder="Enter ST.RL"
                               size="8">
                        <button type="button" class="clear-btn" onclick="clearInput('rlInput')">×</button>
                    </div>
                </div>
            </fieldset>

            <div class="section-header">OBSERVATION DATA</div>
            
            <div class="input-row">
                <div class="input-group">
                    <label for="brgInput">Brg:</label>
                    <div class="number-input-container">
                        <input id="brgInput" name="text5" type="text" 
                               inputmode="decimal" 
                               pattern="[0-9.]*" 
                               placeholder="Enter bearing"
                               size="9">
                        <button type="button" class="clear-btn" onclick="clearInput('brgInput')">×</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="vaInput">VA:</label>
                    <div class="number-input-container">
                        <input id="vaInput" name="text6" type="text" 
                               inputmode="decimal" 
                               pattern="[0-9.]*" 
                               placeholder="Enter VA"
                               size="9">
                        <button type="button" class="clear-btn" onclick="clearInput('vaInput')">×</button>
                    </div>
                </div>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label for="sdInput">SD:</label>
                    <div class="number-input-container">
                        <input id="sdInput" name="text7" type="text" 
                               inputmode="decimal" 
                               pattern="[0-9.]*" 
                               placeholder="Enter SD"
                               size="9">
                        <button type="button" class="clear-btn" onclick="clearInput('sdInput')">×</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="phInput">PH:</label>
                    <div class="number-input-container">
                        <input id="phInput" name="text8" type="text" 
                               inputmode="decimal" 
                               pattern="[0-9.]*" 
                               placeholder="Enter PH"
                               size="9">
                        <button type="button" class="clear-btn" onclick="clearInput('phInput')">×</button>
                    </div>
                </div>
            </div>

            <div class="section-header">BACKSIGHT STATION</div>
            
            <div class="form-group">
                <label for="toStationSelect">Station:</label>
                <select id="toStationSelect" name="staionselect2">
                    <option value="Station Name">Station Name</option>
                </select>
            </div>
            
            <div class="input-row">
                <div class="input-group">
                    <label for="bsnInput">B.S N:</label>
                    <div class="number-input-container">
                        <input id="bsnInput" name="text10" type="text" 
                               inputmode="decimal" 
                               pattern="[0-9.]*" 
                               placeholder="Enter B.S N"
                               size="12">
                        <button type="button" class="clear-btn" onclick="clearInput('bsnInput')">×</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="bseInput">B.S E:</label>
                    <div class="number-input-container">
                        <input id="bseInput" name="text11" type="text" 
                               inputmode="decimal" 
                               pattern="[0-9.]*" 
                               placeholder="Enter B.S E"
                               size="12">
                        <button type="button" class="clear-btn" onclick="clearInput('bseInput')">×</button>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label for="bsbrgInput">B.S Brg:</label>
                <div class="number-input-container">
                    <input id="bsbrgInput" name="text12" type="text" 
                           inputmode="decimal" 
                           pattern="[0-9.]*" 
                           placeholder="Enter B.S Brg"
                           size="9">
                    <button type="button" class="clear-btn" onclick="clearInput('bsbrgInput')">×</button>
                </div>
            </div>

            <div class="button-group">
                <input type="button" value="RUN CALCULATION" onclick="RUNIt()">
                <input type="button" value="CLEAR DATA" onclick="CLSIt2()">
            </div>

            <div class="section-header">SIN SECTION RESULTS</div>
            
            <div class="result-section">
                <div class="input-row">
                    <div class="input-group">
                        <label>Nx:</label>
                        <input name="text13" type="text" readonly style="background: #f0f0f0;">
                    </div>
                    
                    <div class="input-group">
                        <label>Ex:</label>
                        <input name="text14" type="text" readonly style="background: #f0f0f0;">
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Coll:</label>
                    <input name="text15" type="text" readonly style="background: #f0f0f0;">
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>T/Brg to ST:</label>
                        <input name="text16" type="text" readonly style="background: #f0f0f0;">
                    </div>
                    
                    <div class="input-group">
                        <label>T/Brg to BS:</label>
                        <input name="text17" type="text" readonly style="background: #f0f0f0;">
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script>
        // Input handling functions
        function clearInput(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;
            input.value = '';
            // Trigger input event
            const event = new Event('input', { bubbles: true });
            input.dispatchEvent(event);
        }

        // Initialize clear button visibility
        function initClearButtons() {
            const inputs = document.querySelectorAll('input[inputmode="decimal"]');
            inputs.forEach(input => {
                const clearBtn = input.parentElement.querySelector('.clear-btn');
                function update() {
                    if (clearBtn) clearBtn.style.display = input.value ? 'block' : 'none';
                }
                input.addEventListener('input', update);
                update();
            });
        }

        // Defensive helper to get the named form
        function STN() {
            return document.forms['STN'] || document.SurveyForm || null;
        }

        // Original functions with modern improvements & defensive checks
        function functionfirst() {
            if (typeof st === 'undefined' || !Array.isArray(st)) {
                throw new Error("station data 'st' is not defined (station.js might be missing or failed).");
            }

            var contractnumber = [];
            var j = 0;
            var temp = "";

            // Defensive: ensure st has at least 2 entries
            if (!st[1]) {
                return;
            }

            contractnumber[0] = st[1][0];

            for (var i = 2; i < st.length; i++) {
                temp = st[i][0];
                if (temp != contractnumber[j]) {
                    j = j + 1;
                    contractnumber[j] = temp;
                }
            }

            // remove exact duplicates
            var z = 0;
            for (var i = contractnumber.length - 1; i > 0; i--) {
                for (var jj = i - 1; jj >= 0; jj--) {
                    if (contractnumber[i] == contractnumber[jj]) {
                        z = z + 1;
                        contractnumber[i] = "";
                        break;
                    }
                }
            }

            j = 0;
            for (var i = 0; i < contractnumber.length; i++) {
                if (contractnumber[i] != "") {
                    contractnumber[j] = contractnumber[i];
                    j = j + 1;
                }
            }

            var F = j; // number of unique
            const contractSelect = document.getElementById('contractSelect');

            // Clear existing options
            contractSelect.innerHTML = '<option value="Select Site">Select Site</option>';

            for (var ii = 0; ii < F; ii++) {
                const option = new Option(contractnumber[ii], contractnumber[ii]);
                contractSelect.add(option);
            }
        }

        function CheckIt3() {
            var form = STN();
            if (!form) return;
            var contactno = form.contact ? form.contact.value : '';
            var countnumber = 1;
            var temp = "";
            // Clear existing options
            const fromSelect = document.getElementById('fromStationSelect');
            const toSelect = document.getElementById('toStationSelect');
            fromSelect.innerHTML = '<option value="Station Name">Station Name</option>';
            toSelect.innerHTML = '<option value="Station Name">Station Name</option>';

            if (typeof st === 'undefined' || !Array.isArray(st)) {
                console.warn("station data 'st' missing when populating stations.");
                return;
            }

            for (var i = 0; i < st.length; i++) {
                temp = st[i][0];
                if (temp == contactno) {
                    countnumber = countnumber + 1;
                    fromSelect.add(new Option(st[i][1], st[i][1]));
                    toSelect.add(new Option(st[i][1], st[i][1]));
                }
            }
        }

        function checkst(stationname, contactno) {
            if (typeof st === 'undefined' || !Array.isArray(st)) return 0;
            var k = 0;
            for (var i = 1; i < st.length; i++) {
                var c = st[i][1];
                var d = st[i][0];
                if (c == stationname && d == contactno) {
                    k = i;
                    break;
                }
            }
            return k;
        }

        function CLSIt2() {
            var form = STN();
            if (!form) return;
            // Clear the common inputs by name (text2..text12)
            for (var i = 2; i <= 12; i++) {
                var name = 'text' + i;
                if (form[name]) form[name].value = '';
            }
            // Clear results
            for (var i = 13; i <= 17; i++) {
                var name = 'text' + i;
                if (form[name]) form[name].value = '';
            }
            // hide localStorage results if any
            try {
                localStorage.removeItem('XXN');
                localStorage.removeItem('XXE');
                localStorage.removeItem('XXL');
            } catch (e) {
                // ignore
            }
        }

        function CheckIt1() {
            var form = STN();
            if (!form) return;
            var Name = form.staionselect1 ? form.staionselect1.value : '';
            var contactno = form.contact ? form.contact.value : '';
            var k = checkst(Name, contactno);
            if (!st[k]) return;
            var n = st[k][2];
            var e = st[k][3];
            var rl = st[k][4];
            form.text2.value = n;
            form.text3.value = e;
            form.text4.value = rl;
        }

        function CheckIt2() {
            var form = STN();
            if (!form) return;
            var Name = form.staionselect2 ? form.staionselect2.value : '';
            var contactno = form.contact ? form.contact.value : '';
            var k = checkst(Name, contactno);
            if (!st[k]) return;
            var n = st[k][2];
            var e = st[k][3];
            form.text10.value = n;
            form.text11.value = e;
        }

        function RUNIt() {
            var form = STN();
            if (!form) return;

            var stn = parseFloat(form.text2.value) || 0;
            var ste = parseFloat(form.text3.value) || 0;
            var rl = parseFloat(form.text4.value) || 0;
            var brg1 = parseFloat(form.text5.value) || 0;
            var va1 = parseFloat(form.text6.value) || 0;
            var sd1 = parseFloat(form.text7.value) || 0;
            var ph1 = parseFloat(form.text8.value) || 0;
            var bsn = parseFloat(form.text10.value) || 0;
            var bse = parseFloat(form.text11.value) || 0;
            var bsb = parseFloat(form.text12.value) || 0;

            // Ensure calculation functions exist
            if (typeof sinsection !== 'function') {
                showInitError("Calculation function 'sinsection' not found. Ensure sinsection.js is loaded and defines sinsection().");
                console.error("sinsection() is missing");
                return;
            }
            if (typeof sinsectioncoll !== 'function') {
                showInitError("Calculation function 'sinsectioncoll' not found. Ensure sinsection.js is loaded and defines sinsectioncoll().");
                console.error("sinsectioncoll() is missing");
                return;
            }

            try {
                var result = sinsection(stn, ste, brg1, va1, sd1, bsn, bse, bsb);
                if (!result || typeof result.nx === 'undefined' || typeof result.ex === 'undefined') {
                    throw new Error("sinsection() returned invalid result: " + JSON.stringify(result));
                }
                var nx = result.nx;
                var ex = result.ex;
                var coll = sinsectioncoll(rl, va1, sd1, ph1);
                var tb1 = joint(nx, ex, stn, ste);
                var tb2 = joint(nx, ex, bsn, bse);

                form.text13.value = fix3(nx);
                form.text14.value = fix3(ex);
                form.text15.value = fix3(coll);
                form.text16.value = dmscode(tb1);
                form.text17.value = dmscode(tb2);

                try {
                    localStorage.XXN = fix3(nx);
                    localStorage.XXE = fix3(ex);
                    localStorage.XXL = fix3(coll);
                } catch (e) {
                    // localStorage might not be available in some browsers or privacy modes
                }

                hideInitError();
            } catch (err) {
                console.error("RUNIt error:", err);
                showInitError("Calculation error: " + (err && err.message ? err.message : String(err)));
            }
        }

        // Helper functions (assuming they are defined in sinsection.js or need to be defined)
        function fix3(z) {
            return (Math.floor(z * 1000 + 0.5)) / 1000;
        }

        function dmscode(z) {
            if (isNaN(z)) return '';
            var d = Math.floor(z);
            var m = Math.floor((z - d) * 60);
            var s = Math.floor((((z - d) * 60 - m) * 60) * 10 + 0.5) / 10;

            if (s >= 60) {
                s -= 60;
                m += 1;
            }
            if (m >= 60) {
                m -= 60;
                d += 1;
            }

            return d + "^" + m + "'" + s + '"';
        }

        function joint(n, e, n2, e2) {
            var x = n2 - n + 1e-12;
            var y = e2 - e;
            var brg = Math.atan(y / x) * 180 / Math.PI;
            if (x < 0) brg += 180;
            if (brg < 0) brg += 360;
            return brg;
        }

        function showInitError(msg) {
            const box = document.getElementById('initError');
            if (!box) return;
            box.textContent = msg;
            box.style.display = 'block';
        }
        function hideInitError() {
            const box = document.getElementById('initError');
            if (!box) return;
            box.style.display = 'none';
            box.textContent = '';
        }

        // Page load initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize clear buttons safely
            try {
                initClearButtons();
            } catch (e) {
                console.warn("initClearButtons failed:", e);
            }

            // Try to run functionfirst (may throw if station data missing)
            try {
                functionfirst();
            } catch (err) {
                console.error("functionfirst() initialization error:", err);
                showInitError("Initialization error: " + (err.message || String(err)));
            }

            // Add event listeners (defensive)
            var contractSelect = document.getElementById('contractSelect');
            if (contractSelect) {
                contractSelect.addEventListener('change', function() {
                    try {
                        CheckIt3();
                    } catch (e) {
                        console.error("CheckIt3 error:", e);
                    }
                });
            }

            var fromSelect = document.getElementById('fromStationSelect');
            if (fromSelect) {
                fromSelect.addEventListener('change', function() {
                    try { CheckIt1(); } catch (e) { console.error(e); }
                });
            }
            var toSelect = document.getElementById('toStationSelect');
            if (toSelect) {
                toSelect.addEventListener('change', function() {
                    try { CheckIt2(); } catch (e) { console.error(e); }
                });
            }

            // Final check for required functions
            if (typeof sinsection !== 'function' || typeof sinsectioncoll !== 'function') {
                console.warn("sinsection or sinsectioncoll missing. Check sinsection.js");
                showInitError("Missing calculation functions. Make sure sinsection.js is loaded and defines sinsection() and sinsectioncoll().");
            }
        });
    </script>
</body>
</html>