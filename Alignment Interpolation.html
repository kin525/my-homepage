<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="ROBOTS" content="NOARCHIVE">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Luen Hing Survey Program - Alignment Interpolation</title>
    <style>
        /* Base reset and responsive design */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 15px;
            line-height: 1.6;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h3 {
            text-align: center;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 24px;
        }

        p {
            margin-bottom: 15px;
        }

        /* Form elements */
        select, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
            -webkit-appearance: none;
            appearance: none;
            background: white;
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #007AFF;
        }

        /* Optimize number input for mobile */
        input[type="text"][inputmode="decimal"] {
            -webkit-user-select: text;
            user-select: text;
        }

        /* iOS Safari optimizations */
        @supports (-webkit-touch-callout: none) {
            input[type="text"][inputmode="decimal"] {
                font-size: 16px; /* Prevent zoom on iOS */
            }
        }

        fieldset {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background: #fafafa;
        }

        legend {
            font-weight: bold;
            padding: 0 10px;
            color: #555;
        }

        /* Buttons */
        input[type="button"] {
            width: 100%;
            padding: 12px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 10px;
        }

        input[type="button"]:active {
            background: #0056cc;
            transform: scale(0.98);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .button-group input[type="button"] {
            flex: 1;
        }

        /* Result section */
        .result-section {
            background: #e8f4ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            select, input[type="text"], input[type="button"] {
                padding: 10px;
                font-size: 14px;
            }
        }

        /* Number input container */
        .number-input-container {
            position: relative;
        }

        .number-input-container input {
            padding-right: 40px;
        }

        .clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 18px;
            color: #999;
            cursor: pointer;
            display: none;
            padding: 5px;
            z-index: 10;
        }

        input:not(:placeholder-shown) + .clear-btn {
            display: block;
        }

        /* Form labels */
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        /* Compact layout for coordinate inputs */
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-group {
            flex: 1;
        }

        .input-group label {
            font-size: 14px;
            margin-bottom: 3px;
        }

        /* Section headers */
        .section-header {
            background: #f0f0f0;
            padding: 8px 15px;
            margin: 20px 0 15px 0;
            border-radius: 6px;
            font-weight: bold;
            color: #555;
            text-align: center;
        }
    </style>
    <script src="Data/liner.js"></script>
    <script src="linerfunction.js"></script>
    <script>
        // Error handling
        function killErrors() {
            return true;
        }
        window.onerror = killErrors;
    </script>
</head>

<body>
    <div class="container">
        <h3>Kin Write Alignment Interpolation</h3>
        <p style="text-align: center; color: #666;">Email: kin525@yahoo.com.hk</p>

        <form name="STN" id="interpolationForm">
            <div class="form-group">
                <label for="contractSelect">Contract Number:</label>
                <select id="contractSelect" name="contact">
                    <option value="Select Site">Select Site</option>
                    <option value="HY-2008-11">HY-2008-11</option>
                    <option value="HY-2013-02">HY-2013-02</option>
                    <option value="HY-2013-03">HY-2013-03</option>
                </select>
            </div>

            <fieldset>
                <legend>Alignment Selection</legend>
                <div class="form-group">
                    <label for="baseLineSelect">Base Line:</label>
                    <select id="baseLineSelect" name="staionselect1">
                        <option value="Base Alignment">Base Alignment</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="secondLineSelect">Second Line:</label>
                    <select id="secondLineSelect" name="staionselect2">
                        <option value="Second Alignment">Second Alignment</option>
                    </select>
                </div>
            </fieldset>

            <fieldset>
                <legend>CH/OS to NE Calculation</legend>
                <div class="input-row">
                    <div class="input-group">
                        <label for="chInput">CH:</label>
                        <div class="number-input-container">
                            <input id="chInput" name="text1" type="text" 
                                   inputmode="decimal" 
                                   pattern="[0-9.]*" 
                                   placeholder="Enter chainage"
                                   size="12">
                            <button type="button" class="clear-btn" onclick="clearInput('chInput')">×</button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="osInput">OS:</label>
                        <div class="number-input-container">
                            <input id="osInput" name="text2" type="text" 
                                   inputmode="decimal" 
                                   pattern="-?[0-9.]*" 
                                   placeholder="Enter offset"
                                   size="12">
                            <button type="button" class="clear-btn" onclick="clearInput('osInput')">×</button>
                        </div>
                    </div>
                </div>
                
                <input type="button" value="CH/OS → NE" onclick="RUNIt1()">
            </fieldset>

            <fieldset>
                <legend>NE to CH/OS Calculation</legend>
                <div class="input-row">
                    <div class="input-group">
                        <label for="nxInput">Nx:</label>
                        <div class="number-input-container">
                            <input id="nxInput" name="text3" type="text" 
                                   inputmode="decimal" 
                                   pattern="[0-9.]*" 
                                   placeholder="Enter Nx"
                                   size="12">
                            <button type="button" class="clear-btn" onclick="clearInput('nxInput')">×</button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="exInput">Ex:</label>
                        <div class="number-input-container">
                            <input id="exInput" name="text4" type="text" 
                                   inputmode="decimal" 
                                   pattern="[0-9.]*" 
                                   placeholder="Enter Ex"
                                   size="12">
                            <button type="button" class="clear-btn" onclick="clearInput('exInput')">×</button>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label for="rlInput">RL:</label>
                    <div class="number-input-container">
                        <input id="rlInput" name="text5" type="text" 
                               inputmode="decimal" 
                               pattern="[0-9.]*" 
                               placeholder="Enter RL"
                               size="12">
                        <button type="button" class="clear-btn" onclick="clearInput('rlInput')">×</button>
                    </div>
                </div>
                
                <div class="button-group">
                    <input type="button" value="CALL ANSWER" onclick="CALL_ANSWER()">
                    <input type="button" value="NE → CH/OS" onclick="RUNIt2()">
                </div>
            </fieldset>

            <div class="section-header">OUTPUT DATA</div>
            
            <div class="result-section">
                <div class="input-group">
                    <input name="text6" type="text" readonly style="background: #f0f0f0;">
                </div>
                
                <div class="input-group">
                    <input name="text7" type="text" readonly style="background: #f0f0f0;">
                </div>
                
                <div class="input-group">
                    <input name="text8" type="text" readonly style="background: #f0f0f0;">
                </div>
            </div>
        </form>
    </div>

    <script>
        // Input handling functions
        function clearInput(inputId) {
            const input = document.getElementById(inputId);
            input.value = '';
        }

        // Initialize clear button visibility
        function initClearButtons() {
            const inputs = document.querySelectorAll('input[inputmode="decimal"]');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    const clearBtn = this.nextElementSibling;
                    if (clearBtn && clearBtn.classList.contains('clear-btn')) {
                        clearBtn.style.display = this.value ? 'block' : 'none';
                    }
                });
            });
        }

        // Original functions with modern improvements
        function CheckIt3(index) {
            const contactno = document.STN.contact.value;
            let countnumber = 1;
            let temp = "";
            let j = 1;

            const baseLineSelect = document.getElementById('baseLineSelect');
            const secondLineSelect = document.getElementById('secondLineSelect');
            
            // Clear existing options
            baseLineSelect.innerHTML = '<option value="Base Alignment">Base Alignment</option>';
            secondLineSelect.innerHTML = '<option value="Second Alignment">Second Alignment</option>';

            for(let i = 0; i < bslink.length; i++) {
                temp = bslink[i][0];
                if (temp === contactno) {
                    countnumber = countnumber + 1;
                    baseLineSelect.add(new Option(bslink[i][1], bslink[i][1]));
                    secondLineSelect.add(new Option(bslink[i][1], bslink[i][1]));
                    j = j + 1;
                }
            }
            baseLineSelect.length = countnumber;
            secondLineSelect.length = countnumber;
        }

        function js_include(script) {
            const scriptElement = document.createElement('script');
            scriptElement.src = script;
            scriptElement.type = 'text/javascript';
            const head = document.getElementsByTagName('head').item(0);
            head.appendChild(scriptElement);
        }

        function Callalignmnetdata() {
            const Name = "Data/" + document.STN.staionselect1.value + ".js";
            js_include(Name);
            
            // Small delay to ensure script is loaded
            setTimeout(() => {
                ChangeBaseinputdata("Inrerprolation.js");
            }, 100);
        }

        function CallSencondalignmnetdata() {
            const Name = "Data/" + document.STN.staionselect2.value + ".js";
            js_include(Name);
        }

        function ChangeBaseinputdata(script) {
            const scriptElement = document.createElement('script');
            scriptElement.src = script;
            scriptElement.type = 'text/javascript';
            const head = document.getElementsByTagName('head').item(0);
            head.appendChild(scriptElement);
        }

        function RUNIt1() {
            document.STN.text6.value = "";
            document.STN.text7.value = "";
            document.STN.text8.value = "";

            const datach = [];
            const datanx = [];
            const dataex = [];
            const datarl = [];

            for (let i = 1; i < baseline.length; i++) {
                datach[i] = baseline[i][0];
                datanx[i] = baseline[i][1];
                dataex[i] = baseline[i][2];
                datarl[i] = baseline[i][3];
            }

            const CH = document.STN.text1.value;
            const OS = document.STN.text2.value;
            let Startnumber = 1;

            for (let i = 1; i < datach.length; i++) {
                const name = fix3(datach[i]);
                if (name < fix3(CH)) {
                    Startnumber = i;
                }
            }

            const temp = datach.length - 1;
            const name = datach[temp];

            if (fix3(CH) > name) {
                alert("Out of Range");
                Startnumber = datach.length - 2;
            }

            let TBRG = joint(datanx[Startnumber], dataex[Startnumber], datanx[Startnumber + 1], dataex[Startnumber + 1]);
            TBRG = dms(TBRG);
            const Tlength = jointdist(datanx[Startnumber], dataex[Startnumber], datanx[Startnumber + 1], dataex[Startnumber + 1]);

            const CHlength = datach[Startnumber + 1] - datach[Startnumber];
            const UseCH = ((fix3(CH) - fix3(datach[Startnumber])) * (Tlength / CHlength)) + fix3(datach[Startnumber]);

            const BaselineLevel = (fix3(datarl[Startnumber + 1]) - fix3(datarl[Startnumber])) / Tlength * (fix3(UseCH) - fix3(datach[Startnumber])) + fix3(datarl[Startnumber]);
            const BaselineNx = fix3(linenx(datanx[Startnumber], dataex[Startnumber], datach[Startnumber], TBRG, UseCH, 0));
            const BaselineEx = fix3(lineex(datanx[Startnumber], dataex[Startnumber], datach[Startnumber], TBRG, UseCH, 0));

            const NX = fix3(linenx(datanx[Startnumber], dataex[Startnumber], datach[Startnumber], TBRG, UseCH, OS));
            const EX = fix3(lineex(datanx[Startnumber], dataex[Startnumber], datach[Startnumber], TBRG, UseCH, OS));

            localStorage.JOINT_N = NX;
            localStorage.JOINT_E = EX;

            document.STN.text6.value = "Nx = " + NX;
            document.STN.text7.value = "Ex = " + EX;

            const Name2 = document.STN.staionselect2.value;

            if (Name2 === "Second Alignment") {
                document.STN.text8.value = "DL = " + fix3(BaselineLevel);
            } else {
                const DesignLevel = Runcrossfalllevel(BaselineNx, BaselineEx, CH, NX, EX, BaselineLevel);
                document.STN.text8.value = "DL = " + fix3(DesignLevel);
            }
        }

        function Runcrossfalllevel(BaseN, BaseE, CH, CheckNx, CheckEx, Level) {
            const datach = [];
            const datanx = [];
            const dataex = [];
            const datarl = [];

            for (let i = 1; i < lineinput.length; i++) {
                datach[i] = lineinput[i][0];
                datanx[i] = lineinput[i][1];
                dataex[i] = lineinput[i][2];
                datarl[i] = lineinput[i][3];
            }

            let Startnumber = 1;

            for (let i = 1; i < datach.length; i++) {
                const name = fix3(datach[i]);
                if (name < fix3(CH)) {
                    Startnumber = i;
                }
            }

            const temp = datach.length - 1;
            const name = datach[temp];

            if (fix3(CH) > name) {
                alert("Out of Range");
                Startnumber = datach.length - 2;
            }

            let TBRG = joint(datanx[Startnumber], dataex[Startnumber], datanx[Startnumber + 1], dataex[Startnumber + 1]);
            TBRG = dms(TBRG);
            const Tlength = jointdist(datanx[Startnumber], dataex[Startnumber], datanx[Startnumber + 1], dataex[Startnumber + 1]);

            const CHlength = datach[Startnumber + 1] - datach[Startnumber];
            const UseCH = ((fix3(CH) - fix3(datach[Startnumber])) * (Tlength / CHlength)) + fix3(datach[Startnumber]);

            const Align2level = (fix3(datarl[Startnumber + 1]) - fix3(datarl[Startnumber])) / Tlength * (fix3(UseCH) - fix3(datach[Startnumber])) + fix3(datarl[Startnumber]);
            const Align2Nx = fix3(linenx(datanx[Startnumber], dataex[Startnumber], datach[Startnumber], TBRG, UseCH, 0));
            const Align2Ex = fix3(lineex(datanx[Startnumber], dataex[Startnumber], datach[Startnumber], TBRG, UseCH, 0));
            
            const Alignmentdist = jointdist(BaseN, BaseE, Align2Nx, Align2Ex);
            TBRG = joint(BaseN, BaseE, Align2Nx, Align2Ex);
            TBRG = dms(TBRG);
            const linelength = linech(BaseN, BaseE, 0, TBRG, CheckNx, CheckEx);
            const CrossFall = (fix4(Align2level) - fix4(Level)) / fix4(Alignmentdist);
            const DesignLevel = (linelength * CrossFall + Level);

            return DesignLevel;
        }

        function RUNIt2() {
            document.STN.text6.value = "";
            document.STN.text7.value = "";
            document.STN.text8.value = "";

            const datach = [];
            const datanx = [];
            const dataex = [];
            const datarl = [];

            for (let i = 1; i < baseline.length; i++) {
                datach[i] = baseline[i][0];
                datanx[i] = baseline[i][1];
                dataex[i] = baseline[i][2];
                datarl[i] = baseline[i][3];
            }

            const NX = document.STN.text3.value;
            const EX = document.STN.text4.value;
            const RL = document.STN.text5.value;

            let Startnumber = 1;
            let RUNCH = 0;
            let RUNOS = 0;
            let Tlength = 0;

            for (let i = 1; i < datach.length; i++) {
                let TBRG = joint(datanx[i], dataex[i], datanx[i + 1], dataex[i + 1]);
                TBRG = dms(TBRG);
                Tlength = jointdist(datanx[i], dataex[i], datanx[i + 1], dataex[i + 1]);
                RUNCH = fix3(linech(datanx[i], dataex[i], datach[i], TBRG, NX, EX));
                RUNOS = fix3(lineos(datanx[i], dataex[i], datach[i], TBRG, NX, EX));
                const CHlength = datach[i + 1] - datach[i];
                const UseCH = fix3(((fix3(RUNCH) - fix3(datach[i])) * (CHlength / Tlength)) + fix3(datach[i]));
                const CCH = UseCH;
                Startnumber = i;
                const BaselineNx = fix3(linenx(datanx[Startnumber], dataex[Startnumber], datach[Startnumber], TBRG, UseCH, 0));
                const BaselineEx = fix3(lineex(datanx[Startnumber], dataex[Startnumber], datach[Startnumber], TBRG, UseCH, 0));

                if (fix3(datach[i + 1]) > fix3(UseCH) || i + 2 === datach.length) {
                    break;
                }
            }

            const BaselineLevel = (fix3(datarl[Startnumber + 1]) - fix3(datarl[Startnumber])) / Tlength * (fix3(RUNCH) - fix3(datach[Startnumber])) + fix3(datarl[Startnumber]);

            const Name2 = document.STN.staionselect2.value;

            let DesignLevel;
            if (Name2 === "Second Alignment") {
                DesignLevel = BaselineLevel;
            } else {
                DesignLevel = Runcrossfalllevel(BaselineNx, BaselineEx, RUNCH, NX, EX, BaselineLevel);
            }

            let Diff = fix3(DesignLevel - RL);
            if (Diff < 0) {
                Diff = "Down = " + Math.abs(Diff);
            } else {
                Diff = "Up = " + Diff;
            }

            document.STN.text6.value = "CH = " + fix3(RUNCH);
            document.STN.text7.value = "OS = " + fix3(RUNOS);
            document.STN.text8.value = "DL = " + fix3(DesignLevel) + "  " + Diff;
        }

        function CALL_ANSWER() {
            document.STN.text3.value = localStorage.ANSWER_N || '';
            document.STN.text4.value = localStorage.ANSWER_E || '';
            document.STN.text5.value = localStorage.ANSWER_RL || '';
        }

        // Helper functions (assuming they are defined in linerfunction.js)
        function fix3(z) {
            return z = Math.floor(z * 1000 + 0.5) / 1000;
        }

        function fix4(z) {
            return z = Math.floor(z * 10000 + 0.5) / 10000;
        }

        function dms(z) {
            const d = Math.floor(z);
            const m = Math.floor((z - Math.floor(z)) * 60);
            let s = Math.floor(((((z - Math.floor(z)) * 60) - Math.floor((z - Math.floor(z)) * 60)) * 60) * 10 + 0.5) / 10;

            if (s >= 60) {
                s = s - 60;
                m = m + 1;
            }
            
            if (m >= 60) {
                m = m - 60;
                d = d + 1;
            }

            const brg = d + (m / 100) + (s / 10000);
            return brg;
        }

        function jointdist(n, e, n2, e2) {
            const x = n2 - n;
            const y = e2 - e;
            const dist = Math.sqrt((Math.pow(x, 2)) + (Math.pow(y, 2)));
            return dist;
        }

        function joint(n, e, n2, e2) {
            const x = n2 - n + 1 / 100000000000;
            const y = e2 - e;
            let brg = Math.atan(y / x) * 180 / 3.14159265358979;
            
            if (x < 0) {
                brg = brg + 180;
            }
            
            if (brg < 0) {
                brg = brg + 360;
            }
            
            return brg;
        }

        // Placeholder implementations for functions from linerfunction.js
        function linenx(bn, be, bh, tb, rh, ro) {
            // Implementation would be in linerfunction.js
            return 0;
        }

        function lineex(bn, be, bh, tb, rh, ro) {
            // Implementation would be in linerfunction.js
            return 0;
        }

        function linech(bn, be, bh, tb, nx, ex) {
            // Implementation would be in linerfunction.js
            return 0;
        }

        function lineos(bn, be, bh, tb, nx, ex) {
            // Implementation would be in linerfunction.js
            return 0;
        }

        // Page load initialization
        document.addEventListener('DOMContentLoaded', function() {
            initClearButtons();
            
            // Add event listeners
            document.getElementById('contractSelect').addEventListener('change', function() {
                CheckIt3(this.selectedIndex);
            });
            
            document.getElementById('baseLineSelect').addEventListener('change', Callalignmnetdata);
            document.getElementById('secondLineSelect').addEventListener('change', CallSencondalignmnetdata);
        });
    </script>
</body>
</html>